@page
@model asp.Pages.Master.OrdersModel
@{
    ViewData["Title"] = "Мои заказы";
}

    <div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Заказы в работе</h1>
        <a href="/Master/Index" class="btn btn-secondary">← Назад</a>
    </div>

    <!-- Фильтры -->
    <div class="row mb-3">
        <div class="col-md-3">
            <label for="masterFilter" class="form-label">Фильтр по мастеру:</label>
            <select class="form-select" id="masterFilter" onchange="filterByMaster()">
                <option value="">Все мастера</option>
                @foreach (var master in Model.Masters)
                {
                    <option value="@master.Id" selected="@(Model.SelectedMasterId == master.Id ? "selected" : null)">
                        @master.Name
                    </option>
                }
            </select>
        </div>
        <div class="col-md-3">
            <label for="statusFilter" class="form-label">Фильтр по статусу:</label>
            <select class="form-select" id="statusFilter" onchange="filterOrders()">
                <option value="">Все статусы</option>
                <option value="диагностика">Диагностика</option>
                <option value="ремонт">Ремонт</option>
            </select>
        </div>
    </div>

    <!-- Таблица заказов -->
    <div class="table-responsive">
        <table class="table table-striped" id="ordersTable">
            <thead>
                <tr>
                    <th>№ заказа</th>
                    <th>Клиент</th>
                    <th>Устройство</th>
                    <th>Статус</th>
                    <th>Дата создания</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var order in Model.Orders)
                {
                    <tr data-status="@order.Status">
                        <td>@order.Id</td>
                        <td>@order.Client?.Name</td>
                        <td>@(order.DeviceType ?? "null") @(order.DeviceModel ?? "null")</td>
                        <td>
                            <span class="badge bg-@(GetStatusBadgeClass(order.Status))">@order.Status</span>
                        </td>
                        <td>@order.CreatedAt.ToString("dd.MM.yyyy HH:mm")</td>
                        <td>
                            <a href="/Master/OrderDetails/@order.Id" class="btn btn-sm btn-primary">Просмотр</a>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    @if (!Model.Orders.Any())
    {
        <div class="alert alert-info mt-3">
            У вас нет назначенных заказов.
        </div>
    }
</div>

@section Scripts {
    <script>
        function filterOrders() {
            const statusFilter = document.getElementById('statusFilter').value;
            const rows = document.querySelectorAll('#ordersTable tbody tr');

            rows.forEach(row => {
                const status = row.getAttribute('data-status');
                if (statusFilter === '' || status === statusFilter) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function filterByMaster() {
            const masterId = document.getElementById('masterFilter').value;
            if (masterId === '') {
                // Перезагрузка страницы без фильтра
                window.location.href = '/Master/Orders';
            } else {
                // Переход с фильтром по мастеру
                window.location.href = `/Master/Orders?masterId=${masterId}`;
            }
        }

        function GetStatusBadgeClass(status) {
            switch (status) {
                case 'Ожидает диагностики': return 'warning';
                case 'В процессе ремонта': return 'info';
                case 'Ремонт завершён': return 'success';
                default: return 'secondary';
            }
        }
    </script>
}

@functions {
    string GetStatusBadgeClass(string status)
    {
        return status switch
        {
            "Ожидает диагностики" => "warning",
            "В процессе ремонта" => "info",
            "Ремонт завершён" => "success",
            _ => "secondary"
        };
    }
}
